================================================================================
  THE DM'S MARKETPLACE - SYSTEM ARCHITECTURE & USER INTERACTIONS
================================================================================

Last Updated: December 2024
Version: 2.0 (React + TypeScript + Firebase)

================================================================================
PROJECT OVERVIEW
================================================================================

WHAT IS THIS?
-------------
A web-based D&D marketplace application that allows Dungeon Masters (DMs) to
create virtual shops for their players to browse and purchase items during
game sessions.

PRIMARY GOAL
------------
Enable DMs to quickly set up immersive shopping experiences for their D&D
campaigns without manually tracking inventory and currency in spreadsheets
or notes.

SECONDARY GOALS
---------------
1. Players can visualize the market/shops their characters are visiting
2. Automatic stock and currency tracking
3. Easy access to official D&D items with DM customization
4. No complex setup required for players (just a URL)
5. Support multiple campaigns/locations per DM

================================================================================
USER TYPES & THEIR GOALS
================================================================================

USER TYPE 1: DUNGEON MASTER (DM)
---------------------------------

WHO THEY ARE:
- Game masters running D&D campaigns
- Need to manage shopping sessions during gameplay
- May run multiple campaigns or story locations
- Want professional-looking shops for immersion

THEIR GOALS:
- Create markets for different story locations (Waterdeep, Baldur's Gate, etc.)
- Build multiple shops within each market (Blacksmith, Magic Shop, Tavern, etc.)
- Stock shops with items (weapons, armor, potions, magic items, etc.)
- Use official D&D items or create custom homebrew items
- Share markets with players via simple URL
- Track which items are in stock
- See how much money each shop has accumulated

THEIR PAIN POINTS (WHAT WE SOLVE):
- Manual tracking in spreadsheets is tedious
- Players asking "what's in the shop?" repeatedly
- Forgetting prices or item stats mid-session
- Losing track of what was purchased
- No visual representation of shops

THEIR WORKFLOW:
1. Create account (email/password)
2. Create a market for their campaign location
3. Add shops to the market (Blacksmith, Alchemist, etc.)
4. Search for official D&D items OR create custom items
5. Add items to shops, set prices and stock levels
6. Customize item prices/stats if needed
7. Share market URL with players via Discord/Slack/email
8. During game session, players browse and buy
9. DM sees stock decrease in real-time
10. Between sessions, DM can restock or add new items

HOW THEY INTERACT WITH THE SYSTEM:
- Authentication: Required (Firebase Auth)
- Access Level: Full CRUD on their own markets/shops/items
- Data Storage: Firebase Firestore
- Real-time Updates: Optional (can see player purchases live)


USER TYPE 2: PLAYER
--------------------

WHO THEY ARE:
- D&D players in a campaign
- Visiting shops during game sessions
- Managing their character's inventory and currency
- May be in multiple campaigns with different DMs

THEIR GOALS:
- Browse available items in shops
- See item details (stats, description, price)
- Purchase items their character can afford
- Track their character's currency (gold, silver, copper)
- Track what they've purchased
- Optionally sell items back to shops

THEIR PAIN POINTS (WHAT WE SOLVE):
- Can't remember what was in the shop
- Need to ask DM for item details repeatedly
- Manual currency calculations are error-prone
- Lost track of what they bought
- Can't see shop when not at game table

THEIR WORKFLOW:
1. Receive market URL from DM (no account needed!)
2. Click URL → Immediately see the market
3. Browse shops in the market
4. Click items to see full details
5. Purchase items (stock decreases globally)
6. Currency auto-calculated and stored in browser
7. Track purchases in localStorage
8. Optionally sell items back to shop

HOW THEY INTERACT WITH THE SYSTEM:
- Authentication: NOT required (anonymous access)
- Access Level: Read-only on markets/shops/items, can trigger stock updates
- Data Storage: Browser localStorage (currency, purchases)
- Real-time Updates: See stock changes if other players buy items

================================================================================
WEBSITE STRUCTURE
================================================================================

MAIN SECTIONS
-------------

1. HOME / LANDING PAGE
   - Explains what the app does
   - Sign up / Login for DMs
   - "Enter Market Code" for Players
   - Featured example market

2. DM DASHBOARD (Authenticated Only)
   - My Markets (list of all markets DM created)
   - Create New Market button
   - Each market shows:
     * Market name
     * Number of shops
     * Access code / shareable URL
     * Active/Inactive toggle
     * Edit / Delete buttons

3. MARKET EDITOR (DM Only)
   - Market details (name, description)
   - List of shops in this market
   - Add Shop button
   - Reorder shops (drag-and-drop)
   - For each shop:
     * Shop name, category, location, shopkeeper
     * List of items
     * Add Item button
     * Edit / Delete shop

4. SHOP EDITOR (DM Only)
   - Shop details form
   - Item catalog:
     * Search official D&D items (via API)
     * Create custom item
     * Import from template
   - Item list with:
     * Name, type, price, stock
     * Edit / Delete / Duplicate buttons
   - Stock management controls

5. ITEM EDITOR (DM Only)
   - Item form with all fields:
     * Basic: name, type, description, weight
     * Cost: amount + currency
     * Type-specific fields (weapon damage, armor AC, etc.)
     * Stock: number or "unlimited"
     * Source: official / custom / modified
   - Preview how item looks to players
   - Save / Cancel

6. D&D API SEARCH MODAL (DM Only)
   - Search bar
   - Category filters (Weapons, Armor, Magic Items, etc.)
   - Results list with:
     * Item name, type, price
     * "Add to Shop" button
   - When selected:
     * Shows full item details
     * DM can modify before adding
     * Saves as "modified" source

7. PLAYER MARKET VIEW (Public - No Auth)
   - URL: /market/{accessCode}
   - Market name and description
   - Player's currency display (from localStorage)
   - Navigation: tabs for each shop
   - Current shop display:
     * Shop name, description, shopkeeper
     * Grid of item cards
     * Each card shows: name, price, rarity, stock status

8. ITEM DETAIL MODAL (Player View)
   - Full item information
   - Stats and effects
   - Current price
   - Player's current currency
   - "Purchase" button (disabled if can't afford or out of stock)
   - Shows change after purchase
   - Purchase confirmation

9. PLAYER WALLET PANEL
   - Current currency (GP, SP, CP)
   - Starting currency
   - Purchase history
   - Sell items interface (optional)
   - Reset session button

================================================================================
DATABASE STRUCTURE (FIREBASE FIRESTORE)
================================================================================

COLLECTIONS
-----------

users/
  {dmId}
    - email: string
    - displayName: string
    - createdAt: timestamp

markets/
  {marketId}
    - name: string                  (e.g., "Waterdeep Campaign")
    - description: string           (e.g., "Shops in the City of Splendors")
    - dmId: string                  (owner reference)
    - accessCode: string            (e.g., "waterdeep-abc123")
    - isActive: boolean             (can toggle on/off)
    - createdAt: timestamp
    - updatedAt: timestamp

shops/
  {shopId}
    - marketId: string              (parent market)
    - name: string                  (e.g., "The Gilded Blade")
    - description: string
    - location: string              (e.g., "Market Square, North Ward")
    - category: string              (blacksmith, magic, alchemist, etc.)
    - shopkeeper: string            (e.g., "Gundren Rockseeker")
    - currency: { cp, sp, gp }      (shop's accumulated money)
    - tags: string[]
    - order: number                 (display order)
    - createdAt: timestamp
    - updatedAt: timestamp

items/
  {itemId}
    - shopId: string                (parent shop)
    - marketId: string              (for easier querying)
    - name: string
    - type: string                  (weapon, armor, consumable, etc.)
    - description: string
    - weight: number | null
    - cost: { amount, currency }
    - stock: number | null          (null = unlimited)
    - priceModifier: number         (optional price adjustment)
    - source: string                (official, custom, modified)
    - officialId: string            (D&D API reference)
    - [type-specific fields]        (damage, AC, effects, etc.)
    - createdAt: timestamp
    - updatedAt: timestamp

================================================================================
DYNAMIC INTERACTIONS & DATA FLOW
================================================================================

INTERACTION 1: DM CREATES MARKET
---------------------------------
1. DM clicks "Create Market"
2. Fills form: name, description
3. System generates unique accessCode (e.g., "waterdeep-abc123")
4. Market saved to Firestore → markets collection
5. DM sees new market in dashboard
6. DM can now add shops to this market

DATA FLOW:
Frontend → MarketService.createMarket() → Firestore → Frontend updates


INTERACTION 2: DM ADDS SHOP
----------------------------
1. DM selects a market
2. Clicks "Add Shop"
3. Fills form: name, category, location, shopkeeper
4. Shop saved to Firestore → shops collection (with marketId reference)
5. Shop appears in market's shop list
6. DM can now add items to this shop

DATA FLOW:
Frontend → ShopService.createShop() → Firestore → Frontend updates


INTERACTION 3: DM SEARCHES D&D API
-----------------------------------
1. DM clicks "Add Item" in a shop
2. Selects "Search Official Items"
3. Types "longsword" in search
4. System calls D&D 5e API
5. Results displayed
6. DM clicks item → sees full details
7. DM can modify price, stats, stock
8. DM clicks "Add to Shop"
9. Item saved to Firestore → items collection

DATA FLOW:
Frontend → DnDApiService.searchEquipment() → D&D API → Frontend displays
Frontend → ItemService.createItem() → Firestore → Frontend updates


INTERACTION 4: DM SHARES MARKET
--------------------------------
1. DM clicks "Share" on a market
2. System generates URL: https://site.com/market/waterdeep-abc123
3. DM copies URL
4. DM shares via Discord, email, etc.
5. Players click URL → directly to market view (no login!)

DATA FLOW:
Frontend → MarketService.getShareableURL() → Copy to clipboard


INTERACTION 5: PLAYER VISITS MARKET
------------------------------------
1. Player clicks market URL
2. Browser navigates to /market/waterdeep-abc123
3. System looks up market by accessCode
4. If found and active → load market data
5. Load all shops in this market
6. Load all items in these shops
7. Display to player
8. Check localStorage for player's currency
9. If none, prompt to set starting currency

DATA FLOW:
URL → Frontend → MarketService.getMarketByAccessCode() → Firestore
→ ShopService.getShopsByMarket() → Firestore
→ ItemService.getItemsByMarket() → Firestore
→ localStorage.getItem('currency') → Display


INTERACTION 6: PLAYER PURCHASES ITEM
-------------------------------------
1. Player clicks item card
2. Item detail modal opens
3. Shows: price, player's currency, change calculation
4. Player clicks "Purchase"
5. System checks:
   - Can player afford? (client-side validation)
   - Is item in stock? (Firestore query)
6. If yes:
   - ATOMIC TRANSACTION: Decrease stock by 1
   - Calculate new player currency
   - Calculate new shop currency
   - Update shop currency in Firestore
   - Save player currency to localStorage
   - Add to purchase history (localStorage)
7. Show success message
8. Modal closes
9. Item card updates to show new stock

DATA FLOW:
Frontend → PurchaseService.purchaseItem()
  → ItemService.decreaseStock() → Firestore TRANSACTION
  → ShopService.updateShopCurrency() → Firestore
  → localStorage.setItem('currency')
  → localStorage.setItem('purchases')
  → Frontend updates

CRITICAL: Stock update is ATOMIC to prevent race conditions if multiple
players buy the same item simultaneously!


INTERACTION 7: REAL-TIME STOCK UPDATES
---------------------------------------
If implemented with Firestore listeners:

1. Player A and Player B both viewing same shop
2. Player A buys last "Potion of Healing" (stock: 1 → 0)
3. Firestore updates item stock
4. Player B's browser has Firestore listener
5. Listener detects change
6. Player B's UI updates to show "OUT OF STOCK"
7. Player B cannot purchase

DATA FLOW:
Player A → Purchase → Firestore update → Firestore listener → Player B's UI


INTERACTION 8: PLAYER SELLS ITEM
---------------------------------
1. Player opens "Sell Item" interface
2. Selects item from their purchase history
3. System calculates sell price (50% of original by default)
4. Player confirms sale
5. System:
   - Increases item stock in Firestore
   - Decreases shop currency
   - Increases player currency (localStorage)
   - Removes from purchase history
6. Show success message

DATA FLOW:
Frontend → PurchaseService.sellItem()
  → ItemService.increaseStock() → Firestore
  → ShopService.updateShopCurrency() → Firestore
  → localStorage updates


INTERACTION 9: DM RESTOCKS SHOP
--------------------------------
1. DM views shop in editor
2. Sees item with stock: 2
3. Clicks "Edit Stock"
4. Changes to 10
5. Saves
6. Firestore updates
7. Players see updated stock immediately (if using listeners)

DATA FLOW:
Frontend → ItemService.setStock() → Firestore → (Listeners) → Player UIs


INTERACTION 10: DM TOGGLES MARKET ACTIVE
-----------------------------------------
1. DM wants to disable market temporarily
2. Clicks toggle on market
3. Market isActive → false
4. Firestore updates
5. Player tries to access URL
6. System checks isActive
7. Shows "Market currently unavailable"

DATA FLOW:
Frontend → MarketService.toggleMarketActive() → Firestore
Player URL → MarketService.getMarketByAccessCode() → null (inactive)

================================================================================
WHY PEOPLE USE THIS
================================================================================

DMs USE THIS BECAUSE:
---------------------
1. SAVES TIME
   - No manual spreadsheet updates during game
   - Don't have to remember prices/stats
   - Instant shop setup with D&D API

2. ENHANCES IMMERSION
   - Players see beautiful shop interface
   - Feels like a real marketplace
   - Professional presentation

3. REDUCES ERRORS
   - Automatic currency calculations
   - Can't oversell (stock tracking)
   - No math mistakes

4. BETTER SESSION FLOW
   - Players shop independently (don't bog down game)
   - DM doesn't have to answer "what's the price?" repeatedly
   - Can prepare shops before session

5. SUPPORTS MULTIPLE CAMPAIGNS
   - Different markets for different locations
   - Keep campaigns organized
   - Reuse items across markets

6. FLEXIBLE & CUSTOMIZABLE
   - Mix official and homebrew items
   - Adjust prices for campaign economy
   - Custom shops for unique settings


PLAYERS USE THIS BECAUSE:
-------------------------
1. EASY ACCESS
   - Just click a link (no account/app needed)
   - Available during and after session
   - Can review purchases later

2. VISUAL & CLEAR
   - See all items at a glance
   - Item stats clearly displayed
   - Know exactly what they can afford

3. AUTONOMOUS SHOPPING
   - Don't have to wait for DM
   - Can browse while other players role-play
   - Make decisions at own pace

4. ACCURATE TRACKING
   - Currency auto-calculated
   - Purchase history saved
   - No forgetting what they bought

5. IMMERSIVE EXPERIENCE
   - Feels like browsing a real shop
   - Fun UI enhances game
   - Better than "the DM reads a list"

================================================================================
TECHNICAL ARCHITECTURE
================================================================================

FRONTEND
--------
- React 19 + TypeScript
- Vite (build tool)
- Zustand (state management)
- TailwindCSS (styling)
- React Router (navigation)

BACKEND
-------
- Firebase Authentication (DM accounts)
- Firebase Firestore (database)
- Firebase Security Rules (access control)

EXTERNAL APIS
-------------
- D&D 5e API (free, no key required)
  https://www.dnd5eapi.co/

DATA STORAGE
------------
DM Data: Firestore (persistent, server-side)
Player Data: localStorage (client-side only)

Why localStorage for players?
- No account needed
- Fast access
- Privacy (not stored server-side)
- Works offline
- Simple implementation

Why Firestore for markets/shops/items?
- Shared across all players
- Real-time updates
- Persistent across sessions
- DM can manage remotely
- Atomic transactions for stock

================================================================================
USER AUTHENTICATION & PERMISSIONS
================================================================================

DMs (Authenticated):
- Can create/edit/delete their own markets
- Can create/edit/delete shops in their markets
- Can create/edit/delete items in their shops
- Can view all their markets/shops/items
- CANNOT access other DMs' data

Players (Anonymous):
- Can view any active market (via URL)
- Can view all shops in that market
- Can view all items in those shops
- Can trigger stock decreases (purchase)
- Can trigger stock increases (sell)
- CANNOT create/delete anything
- CANNOT access DM dashboard

Security Rules (Firestore):
- Markets: DMs can CRUD their own, anyone can read active ones
- Shops: DMs can CRUD their own, anyone can read
- Items: DMs can CRUD their own, anyone can read and update stock
- Users: Users can only read/write their own profile

================================================================================
KEY FEATURES
================================================================================

MUST HAVE (MVP):
- DM authentication
- Create markets
- Create shops in markets
- Add items to shops
- Share market URL
- Player view market
- Player purchase items
- Stock tracking
- Currency calculations

SHOULD HAVE:
- D&D API integration
- Search official items
- Duplicate items
- Reorder shops
- Toggle market active/inactive
- Purchase history
- Sell items back

NICE TO HAVE:
- Real-time updates
- Shop themes/styling
- Item images
- DM analytics (what sells most)
- Player wishlist
- Discount system
- Special events (sales)

================================================================================
SUCCESS METRICS
================================================================================

This project is successful if:
1. DMs can set up a market in < 5 minutes
2. Players can access market with 1 click (URL)
3. Stock tracking is 100% accurate (no race conditions)
4. Currency calculations have 0 errors
5. DMs report spending less time on shopping sessions
6. Players report better immersion in game

================================================================================
FUTURE ENHANCEMENTS
================================================================================

POTENTIAL FEATURES:
- Mobile app version
- Offline mode for players
- DM notifications when items sell
- Shop revenue analytics
- Item bundling (buy 3, get discount)
- Quest rewards (free items)
- Player reputation system
- Shop reviews/ratings
- NPC shopkeeper dialog
- Seasonal events
- Import/export markets
- Templates for common shop types
- AI-generated item descriptions
- Voice commands for accessibility

================================================================================
END OF ARCHITECTURE DOCUMENT
================================================================================
